# Структура проекта BotAnketGirlGame

## Обзор

Telegram бот на aiogram-dialog для платформы Xplay - бронирование игровых встреч с девушками.

## Архитектура

### Технологический стек
- **aiogram 3.13.1** - фреймворк для Telegram ботов
- **aiogram-dialog 2.1.0** - система диалогов
- **SQLAlchemy 2.0** - ORM для работы с БД
- **aiosqlite** - асинхронный драйвер для SQLite
- **python-dotenv** - управление переменными окружения

### Структура директорий

```
BotAnketGirlGame/
├── bot/                          # Основной пакет бота
│   ├── __init__.py
│   ├── main.py                   # Точка входа, запуск бота
│   ├── config.py                 # Конфигурация (токен, админы, БД)
│   │
│   ├── database/                  # Работа с базой данных
│   │   ├── __init__.py
│   │   ├── models.py             # SQLAlchemy модели
│   │   ├── database.py           # Подключение к БД
│   │   └── repositories.py       # Репозитории (CRUD операции)
│   │
│   ├── dialogs/                   # Диалоги aiogram-dialog
│   │   ├── __init__.py
│   │   ├── user/                 # Пользовательские диалоги
│   │   │   ├── __init__.py
│   │   │   ├── start.py          # Старт, правила, приветствие
│   │   │   ├── main_menu.py      # Главное меню
│   │   │   ├── profiles.py       # Просмотр анкет (по фото/играм)
│   │   │   ├── booking.py        # Бронирование встреч
│   │   │   └── cabinet.py        # Личный кабинет, заказы
│   │   └── admin/                 # Админские диалоги
│   │       ├── __init__.py
│   │       ├── menu.py           # Админ меню
│   │       ├── profiles.py       # CRUD анкет
│   │       ├── games.py          # Управление играми
│   │       └── orders.py         # Управление заказами
│   │
│   ├── handlers/                  # Обработчики событий
│   │   ├── __init__.py
│   │   ├── errors.py             # Обработка ошибок
│   │   └── support.py            # Обработка чата с админом
│   │
│   ├── services/                  # Бизнес-логика
│   │   ├── __init__.py
│   │   ├── notifications.py      # Уведомления админу
│   │   ├── reminders.py          # Напоминания о встречах
│   │   └── payment.py             # Расчет стоимости заказов
│   │
│   ├── filters/                    # Фильтры для хендлеров
│   │   ├── __init__.py
│   │   └── admin.py              # Фильтр проверки админа
│   │
│   └── utils/                      # Утилиты
│       ├── __init__.py
│       ├── validators.py          # Валидация данных
│       └── formatters.py          # Форматирование сообщений
│
├── data/                           # Данные (БД, медиа)
│   └── bot.db                     # SQLite база данных
│
├── .env                            # Переменные окружения (не в git)
├── .env.example                    # Пример конфигурации
├── .gitignore
├── requirements.txt                # Зависимости Python
├── README.md                       # Документация
├── STRUCTURE.md                    # Этот файл
└── QUESTIONS.md                    # Уточняющие вопросы
```

## Модели базы данных

### User (Пользователь)
- `id` - первичный ключ
- `telegram_id` - ID пользователя в Telegram
- `username` - username пользователя
- `first_name` - имя пользователя
- `rules_accepted` - принял ли правила
- `rules_accepted_at` - когда принял правила
- `created_at` - дата регистрации

### Profile (Анкета девушки)
- `id` - первичный ключ
- `name` - имя
- `age` - возраст
- `description` - описание
- `audio_chat_price` - цена аудио-чата за час
- `video_chat_price` - цена видео-чата за час
- `private_price` - цена приватки
- `channel_link` - ссылка на канал
- `photo_ids` - JSON массив file_id фотографий (3 шт)
- `created_at`, `updated_at` - даты

### Game (Игра)
- `id` - первичный ключ
- `name` - название игры (уникальное)
- `created_at` - дата добавления

### ProfileGame (Связь анкет и игр)
- `id` - первичный ключ
- `profile_id` - ID анкеты
- `game_id` - ID игры

### Order (Заказ)
- `id` - первичный ключ
- `order_number` - номер заказа (#321)
- `user_id` - ID пользователя
- `profile_id` - ID анкеты
- `format_type` - тип ("audio" или "video")
- `game_id` - ID игры
- `game_name` - название игры на момент заказа
- `date` - дата и время встречи
- `duration_hours` - продолжительность в часах
- `participants_count` - количество участников
- `base_price` - базовая цена
- `additional_participants_price` - доплата за участников
- `total_price` - итоговая цена
- `payment_status` - статус оплаты (not_paid, processing, paid)
- `conference_link` - ссылка на конференцию
- `reminder_sent` - отправлено ли напоминание
- `notification_enabled` - включены ли уведомления
- `created_at`, `updated_at` - даты

## Потоки пользователя

### 1. Старт и правила
```
/start → Правила → Подтвердить → Приветствие → Главное меню
```

### 2. Просмотр анкет (по фото)
```
Главное меню → Смотреть анкеты (по фото) → 
  → Анкета 1 → [Следующая] → Анкета 2 → [Предыдущая/Следующая] → ...
  → Выбор услуги (Аудио/Видео/Приватка) → Бронирование
```

### 3. Просмотр анкет (по играм)
```
Главное меню → Смотреть анкеты (по играм) → 
  → Список игр (10 шт) → [Следующая страница] → 
  → Выбор игры → Анкеты с этой игрой → Выбор услуги → Бронирование
```

### 4. Бронирование
```
Выбор услуги → Подтверждение → 
  → Выбор игры → Дата → Время → Часы → Участники → 
  → Расчет стоимости → Подтверждение → Заказ создан
```

### 5. Личный кабинет
```
Главное меню → Личный кабинет → 
  → Мои заказы → Список заказов → Действия с заказом
  → Поддержка → Чат с админом
```

## Потоки администратора

### 1. Управление анкетами
```
Админ меню → Список анкет → 
  → Добавить анкету → Заполнение данных → Сохранение
  → Редактировать анкету → Изменение данных → Сохранение
  → Удалить анкету → Подтверждение → Удаление
```

### 2. Управление играми
```
Админ меню → Игры → 
  → Список игр → Поиск → Удаление
  → Добавить игру → Ввод названия → Сохранение
```

### 3. Управление заказами
```
Админ меню → Заказы → Список заказов → 
  → Выбор заказа → 
    → Изменить дату/время
    → Включить/выключить уведомления
    → Проверить оплату → Изменить статус → Добавить ссылку
    → Отменить заказ
    → Написать пользователю
    → Написать девушке
```

## Сервисы

### notifications.py
- Отправка уведомлений админу о новых заказах
- Уведомления о необходимости проверить оплату
- Уведомления об отмене заказов

### reminders.py
- Напоминания за 15 минут до встречи (пользователю и девушке)
- Сообщение после окончания встречи
- Использование планировщика задач (APScheduler)

### payment.py
- Расчет базовой стоимости
- Расчет доплаты за дополнительных участников (50% за каждого)
- Итоговый расчет стоимости

## Ключевые особенности

1. **Диалоговая система** - все взаимодействие через aiogram-dialog
2. **Асинхронность** - полная асинхронная работа с БД и API
3. **Модульность** - четкое разделение на слои (dialogs, services, database)
4. **Расширяемость** - легко добавить новые функции
5. **Безопасность** - проверка прав доступа, валидация данных

## Следующие шаги

1. ✅ Создана структура проекта
2. ⏳ Ожидание ответов на уточняющие вопросы
3. ⏳ Реализация пользовательских диалогов
4. ⏳ Реализация админских диалогов
5. ⏳ Реализация сервисов (уведомления, напоминания)
6. ⏳ Тестирование
7. ⏳ Деплой

